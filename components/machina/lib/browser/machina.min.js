/*
 machina
 Author: Jim Cowart (http://freshbrewedcode.com/jimcowart)
 License: Dual licensed MIT (http://www.opensource.org/licenses/mit-license) & GPL (http://www.opensource.org/licenses/gpl-license)
 Version 0.3.0
 */
(function(e,t){typeof define=="function"&&define.amd?define(["underscore"],function(n){return t(n,e)}):e.machina=t(e._,e)})(this,function(e,t,n){var r=[].slice,i="transition",s="handler",o="handling",u="handled",a="nohandler",f="transition",l="invalidstate",c="deferred",h="newfsm",p={makeFsmNamespace:function(){var e=0;return function(){return"fsm."+e++}}(),getDefaultOptions:function(){return{initialState:"uninitialized",eventListeners:{"*":[]},states:{},eventQueue:[],namespace:p.makeFsmNamespace(),targetReplayState:"",state:n,priorState:n,_priorAction:"",_currentAction:""}}};if(!e.deepExtend){var d={"*":function(e,t,n){e[t]=n},object:function(e,t,n){e[t]=g(e[t]||{},n)},array:function(t,n,r){t[n]=[],e.each(r,function(e,r){d[m(e)](t[n],r,e)},this)}},v=function(t){return e.isArray(t)?"array":e.isDate(t)?"date":e.isRegExp(t)?"regex":typeof t},m=function(e){var t=v(e);return d[t]?t:"*"},g=function(t){return e.each(r.call(arguments,1),function(n){e.each(n,function(e,n){d[m(e)](t,n,e)})}),t};e.mixin({deepExtend:g})}var y=function(t){e.extend(this,t),e.defaults(this,p.getDefaultOptions()),this.initialize(),E.emit(h,this),this.initialState&&this.transition(this.initialState)};e.extend(y.prototype,{initialize:function(){},emit:function(t){var n=arguments;this.eventListeners["*"]&&e.each(this.eventListeners["*"],function(e){try{e.apply(this,r.call(n,0))}catch(t){console&&typeof console.log!="undefined"&&console.log(t.toString())}}),this.eventListeners[t]&&e.each(this.eventListeners[t],function(e){try{e.apply(this,r.call(n,1))}catch(t){console&&typeof console.log!="undefined"&&console.log(t.toString())}})},handle:function(e){if(!this.inExitHandler){var t=this.states,i=this.state,f=r.call(arguments,0),l,c,h;this.currentActionArgs=f,t[i][e]||t[i]["*"]||this["*"]?(l=t[i][e]?e:"*",h=l==="*",t[i][l]?(c=t[i][l],this._currentAction=i+"."+l):(c=this["*"],this._currentAction="*"),this.emit.call(this,o,{inputType:e,args:f.slice(1)}),Object.prototype.toString.call(c)==="[object String]"?this.transition(c):c.apply(this,h?f:f.slice(1)),this.emit.call(this,u,{inputType:e,args:f.slice(1)}),this._priorAction=this._currentAction,this._currentAction="",this.processQueue(s)):this.emit.call(this,a,{inputType:e,args:f.slice(1)}),this.currentActionArgs=n}},transition:function(e){if(!this.inExitHandler){var t;if(this.states[e]){this.targetReplayState=e,this.priorState=this.state,this.state=e,t=this.priorState,this.states[t]&&this.states[t]._onExit&&(this.inExitHandler=!0,this.states[t]._onExit.call(this),this.inExitHandler=!1),this.emit.call(this,f,{fromState:t,toState:e}),this.states[e]._onEnter&&this.states[e]._onEnter.call(this),this.targetReplayState===e&&this.processQueue(i);return}this.emit.call(this,l,{state:this.state,attemptedState:e})}},processQueue:function(t){var n=t===i?function(e){return e.type===i&&(!e.untilState||e.untilState===this.state)}:function(e){return e.type===s},r=e.filter(this.eventQueue,n,this);this.eventQueue=e.difference(this.eventQueue,r),e.each(r,function(e){this.handle.apply(this,e.args)},this)},clearQueue:function(t,n){if(!t)this.eventQueue=[];else{var r;t===i?r=function(e){return e.type===i&&(n?e.untilState===n:!0)}:t===s&&(r=function(e){return e.type===s}),this.eventQueue=e.filter(this.eventQueue,r)}},deferUntilTransition:function(e){if(this.currentActionArgs){var t={type:i,untilState:e,args:this.currentActionArgs};this.eventQueue.push(t),this.emit.call(this,c,{state:this.state,queuedArgs:t})}},deferUntilNextHandler:function(){if(this.currentActionArgs){var e={type:i,args:this.currentActionArgs};this.eventQueue.push(e),this.emit.call(this,c,{state:this.state,queuedArgs:e})}},on:function(e,t){var n=this;return n.eventListeners[e]||(n.eventListeners[e]=[]),n.eventListeners[e].push(t),{eventName:e,callback:t,off:function(){n.off(e,t)}}},off:function(t,n){t?this.eventListeners[t]&&(n?this.eventListeners[t]=e.without(this.eventListeners[t],n):this.eventListeners[t]=[]):this.eventListeners={}}}),y.prototype.trigger=y.prototype.emit;var b=function(){},w=function(t,n,r){var i;return n&&n.hasOwnProperty("constructor")?i=n.constructor:i=function(){t.apply(this,arguments)},e.deepExtend(i,t),b.prototype=t.prototype,i.prototype=new b,n&&e.deepExtend(i.prototype,n),r&&e.deepExtend(i,r),i.prototype.constructor=i,i.__super__=t.prototype,i};y.extend=function(e,t){var n=w(this,e,t);return n.extend=this.extend,n};var E={Fsm:y,utils:p,on:function(e,t){return this.eventListeners[e]||(this.eventListeners[e]=[]),this.eventListeners[e].push(t),t},off:function(t,n){this.eventListeners[t]&&(this.eventListeners[t]=e.without(this.eventListeners[t],n))},trigger:function(t){var n=0,i,s=arguments,o=this.eventListeners[t]||[];o&&o.length&&e.each(o,function(e){e.apply(null,r.call(s,1))})},eventListeners:{newFsm:[]}};return E.emit=E.trigger,E})